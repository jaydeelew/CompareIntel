name: PWA Testing

on:
  push:
    branches: [master]
    paths:
      - 'frontend/**'
      - '.github/workflows/pwa-testing.yml'
  pull_request:
    branches: [master]
    paths:
      - 'frontend/**'
      - '.github/workflows/pwa-testing.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # PWA Feature Testing
  # ============================================================================
  pwa-test:
    name: PWA Feature Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      DATABASE_URL: sqlite:///./test-pwa.db
      SECRET_KEY: test-secret-key-for-pwa-testing
      ENVIRONMENT: development
      SKIP_CONFIG_VALIDATION: true
      CI: true
      PLAYWRIGHT_BASE_URL: http://localhost:5173
      BACKEND_URL: http://localhost:8000
      OPENROUTER_API_KEY: ${{ secrets.TEST_OPENROUTER_API_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install backend dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi
      
      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend for PWA testing
        working-directory: frontend
        run: npm run build
      
      - name: Validate PWA manifest
        working-directory: frontend
        run: |
          # Check if manifest.json exists and is valid
          MANIFEST_FILE=""
          if [ -f "dist/manifest.json" ]; then
            MANIFEST_FILE="dist/manifest.json"
          elif [ -f "dist/manifest.webmanifest" ]; then
            MANIFEST_FILE="dist/manifest.webmanifest"
          else
            # Try to find any manifest file
            MANIFEST_FILE=$(find dist -name "manifest*.json" -o -name "manifest*.webmanifest" | head -n 1)
          fi
          
          if [ -n "$MANIFEST_FILE" ] && [ -f "$MANIFEST_FILE" ]; then
            echo "✅ PWA manifest found: $MANIFEST_FILE"
            # Basic JSON validation
            if command -v python3 &> /dev/null; then
              python3 -m json.tool "$MANIFEST_FILE" > /dev/null && echo "✅ Manifest JSON is valid"
            fi
          else
            echo "⚠️  Warning: PWA manifest not found"
          fi
      
      - name: Check service worker registration
        working-directory: frontend
        run: |
          # Check if service worker file exists
          if find dist -name "sw.js" -o -name "service-worker.js" -o -name "sw.*.js" | grep -q .; then
            echo "✅ Service worker file found"
          else
            echo "⚠️  Warning: Service worker file not found"
          fi
      
      - name: Install Playwright browsers
        run: |
          cd frontend
          npx playwright install --with-deps chromium
      
      - name: Initialize test database directory
        run: |
          cd backend
          mkdir -p data
          touch data/.gitkeep || true
      
      - name: Test PWA features with Playwright
        working-directory: frontend
        run: |
          # Test PWA installation, offline functionality, etc.
          npm run test:e2e -- \
            --project=chromium \
            --grep="(pwa|offline|service.worker|install)" \
            --timeout=90000
      
      - name: Upload PWA test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pwa-test-results
          path: frontend/test-results/
          retention-days: 7

  # ============================================================================
  # PWA Manifest & Assets Validation
  # ============================================================================
  # Note: Full Lighthouse audits (including PWA category) run in performance.yml.
  # This job focuses on structural PWA validation that doesn't need a running server.
  pwa-manifest-validation:
    name: PWA Manifest & Assets Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies and build
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Validate PWA manifest structure
        working-directory: frontend
        run: |
          python3 -c "
          import json, sys, glob

          # Find manifest file
          manifests = glob.glob('dist/manifest*.json') + glob.glob('dist/manifest*.webmanifest')
          if not manifests:
              print('❌ No PWA manifest found in dist/')
              sys.exit(1)

          manifest_path = manifests[0]
          print(f'Found manifest: {manifest_path}')

          with open(manifest_path) as f:
              m = json.load(f)

          errors = []

          # Required fields for installable PWA
          required = ['name', 'short_name', 'start_url', 'display', 'icons']
          for field in required:
              if field not in m:
                  errors.append(f'Missing required field: {field}')

          # Validate display mode
          valid_displays = ['standalone', 'fullscreen', 'minimal-ui', 'browser']
          if m.get('display') not in valid_displays:
              errors.append(f'Invalid display mode: {m.get(\"display\")}')

          # Validate icons (need at least 192x192 and 512x512 for installability)
          icons = m.get('icons', [])
          icon_sizes = {icon.get('sizes', '') for icon in icons}
          if '192x192' not in icon_sizes:
              errors.append('Missing 192x192 icon (required for installability)')
          if '512x512' not in icon_sizes:
              errors.append('Missing 512x512 icon (required for installability)')

          # Validate theme_color and background_color (recommended)
          if 'theme_color' not in m:
              print('⚠️  Warning: theme_color not set')
          if 'background_color' not in m:
              print('⚠️  Warning: background_color not set')

          if errors:
              for e in errors:
                  print(f'❌ {e}')
              sys.exit(1)
          else:
              print('✅ PWA manifest validation passed')
              print(f'   Name: {m.get(\"name\")}')
              print(f'   Display: {m.get(\"display\")}')
              print(f'   Icons: {len(icons)} defined')
          "

      - name: Verify service worker in build output
        working-directory: frontend
        run: |
          SW_FILES=$(find dist -name "sw.js" -o -name "service-worker.js" -o -name "sw.*.js" 2>/dev/null)
          if [ -n "$SW_FILES" ]; then
            echo "✅ Service worker found:"
            echo "$SW_FILES"
            # Verify it's not empty
            for f in $SW_FILES; do
              SIZE=$(wc -c < "$f")
              if [ "$SIZE" -lt 100 ]; then
                echo "⚠️  Service worker $f seems too small ($SIZE bytes)"
              else
                echo "   $f: $SIZE bytes"
              fi
            done
          else
            echo "❌ No service worker found in build output"
            exit 1
          fi

      - name: Check HTML references manifest and service worker
        working-directory: frontend
        run: |
          if [ -f dist/index.html ]; then
            # Check manifest link
            if grep -q 'manifest' dist/index.html; then
              echo "✅ index.html references manifest"
            else
              echo "❌ index.html missing manifest link"
              exit 1
            fi
          fi
