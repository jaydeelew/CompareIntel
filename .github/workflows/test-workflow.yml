name: Test Workflow

on:
  pull_request:
  push:
    branches: [master, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[no ci]') && !contains(github.event.head_commit.message, '[skip actions]') && !contains(github.event.head_commit.message, '***NO_CI***')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]') && !contains(github.event.pull_request.title, '[no ci]') && !contains(github.event.pull_request.title, '[skip actions]') && !contains(github.event.pull_request.title, '***NO_CI***') && (!contains(github.event.pull_request.body, '[skip ci]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[ci skip]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[no ci]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[skip actions]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '***NO_CI***') || github.event.pull_request.body == null))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements*.txt
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpq-dev
      
      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
      
      - name: Run backend unit tests
        working-directory: ./backend
        run: |
          pytest tests/unit/ -v --cov=app --cov-report=xml --cov-report=term-missing
      
      - name: Run backend integration tests
        working-directory: ./backend
        run: |
          pytest tests/integration/ -v --cov=app --cov-report=xml --cov-report=term-missing --cov-append
      
      - name: Run backend E2E tests
        working-directory: ./backend
        run: |
          pytest tests/e2e/ -v --cov=app --cov-report=xml --cov-report=term-missing --cov-append
      
      - name: Generate coverage report
        if: success()
        working-directory: ./backend
        run: |
          # Generate HTML report from existing coverage data
          # pytest-cov stores data in .coverage, use coverage command to generate HTML
          python -m coverage html --directory=htmlcov || echo "Warning: Could not generate HTML coverage report"
      
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: Upload coverage report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: backend/htmlcov/
          retention-days: 7
          if-no-files-found: ignore

  frontend-unit-tests:
    name: Frontend Unit/Integration Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[no ci]') && !contains(github.event.head_commit.message, '[skip actions]') && !contains(github.event.head_commit.message, '***NO_CI***')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]') && !contains(github.event.pull_request.title, '[no ci]') && !contains(github.event.pull_request.title, '[skip actions]') && !contains(github.event.pull_request.title, '***NO_CI***') && (!contains(github.event.pull_request.body, '[skip ci]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[ci skip]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[no ci]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[skip actions]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '***NO_CI***') || github.event.pull_request.body == null))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run unit and integration tests
        working-directory: ./frontend
        run: npm run test:run
      
      - name: Generate coverage report
        working-directory: ./frontend
        run: npm run test:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: frontend/coverage/
          retention-days: 7

  frontend-e2e-tests:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    needs: [frontend-unit-tests]
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[no ci]') && !contains(github.event.head_commit.message, '[skip actions]') && !contains(github.event.head_commit.message, '***NO_CI***')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]') && !contains(github.event.pull_request.title, '[no ci]') && !contains(github.event.pull_request.title, '[skip actions]') && !contains(github.event.pull_request.title, '***NO_CI***') && (!contains(github.event.pull_request.body, '[skip ci]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[ci skip]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[no ci]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[skip actions]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '***NO_CI***') || github.event.pull_request.body == null))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium firefox webkit
      
      - name: Set up Python (for backend)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements*.txt
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Install dev dependencies if they exist (needed for dev endpoints)
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi
      
      - name: Initialize test database directory
        working-directory: ./backend
        run: |
          # Ensure backend/data directory exists (used by database.py for SQLite)
          mkdir -p data
          # Ensure database directory is writable
          touch data/.gitkeep || true
          # Also ensure backend directory itself is writable for test-e2e.db
          touch test-e2e.db.tmp && rm test-e2e.db.tmp || true
      
      - name: Run E2E tests
        working-directory: ./frontend
        timeout-minutes: 90
        run: npm run test:e2e -- --project=chromium --project=firefox --project=webkit --project='Mobile Safari - iPhone 12' --project='Mobile Chrome - Pixel 5' --timeout=90000
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:5173
          BACKEND_URL: http://localhost:8000
          SECRET_KEY: test-secret-key-for-ci-testing-only-32chars
          OPENROUTER_API_KEY: test-api-key-for-ci-testing-only
          ENVIRONMENT: development
          # Use relative path - backend server runs from backend/ directory, so ./test-e2e.db works
          DATABASE_URL: sqlite:///./test-e2e.db
          # Test user credentials for E2E tests
          TEST_FREE_EMAIL: free@test.com
          TEST_FREE_PASSWORD: Test12345678/
          ADMIN_EMAIL: jaydeelew@gmail.com
          ADMIN_PASSWORD: sf*88323?ddpdRRl
          # Playwright will automatically start both frontend and backend servers via webServer config
          # Tests run on a subset of projects in CI: 3 desktop browsers (Chromium, Firefox, Safari) + 2 mobile devices (iOS/Android)
          # This reduces test time while still covering major platforms
          # Increased timeout to 90s per test to account for CI environment slowness
      
      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7
      
      - name: Upload Playwright screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: frontend/test-results/
          retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-unit-tests, frontend-e2e-tests]
    if: |
      always() &&
      (github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[ci skip]') && !contains(github.event.head_commit.message, '[no ci]') && !contains(github.event.head_commit.message, '[skip actions]') && !contains(github.event.head_commit.message, '***NO_CI***')) ||
      (github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[skip ci]') && !contains(github.event.pull_request.title, '[ci skip]') && !contains(github.event.pull_request.title, '[no ci]') && !contains(github.event.pull_request.title, '[skip actions]') && !contains(github.event.pull_request.title, '***NO_CI***') && (!contains(github.event.pull_request.body, '[skip ci]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[ci skip]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[no ci]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '[skip actions]') || github.event.pull_request.body == null) && (!contains(github.event.pull_request.body, '***NO_CI***') || github.event.pull_request.body == null)))
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download backend coverage
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage-report
          path: ./backend-coverage
      
      - name: Download frontend coverage
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-report
          path: ./frontend-coverage
      
      - name: Download Playwright report
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: playwright-report
          path: ./playwright-report
      
      - name: Create test summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Backend Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          if [ -d "./backend-coverage" ]; then
            echo "- ✅ Coverage report available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⚠️ Coverage report not available (tests may have failed)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend Unit/Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.frontend-unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          if [ -d "./frontend-coverage" ]; then
            echo "- ✅ Coverage report available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⚠️ Coverage report not available (tests may have failed)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend E2E Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.frontend-e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Includes desktop browsers (Chromium, Firefox, Safari) and mobile devices (iPhone 12, Pixel 5)" >> $GITHUB_STEP_SUMMARY
          if [ -d "./playwright-report" ]; then
            echo "- ✅ Test report available in artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ⚠️ Test report not available (tests may have failed or timed out)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- Backend coverage: \`backend-coverage-report\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend coverage: \`frontend-coverage-report\`" >> $GITHUB_STEP_SUMMARY
          echo "- Playwright report: \`playwright-report\`" >> $GITHUB_STEP_SUMMARY
