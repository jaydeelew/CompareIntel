============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0 -- /home/dan_wsl/jaydeelew/CompareIntel/backend/venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/dan_wsl/jaydeelew/CompareIntel/backend
configfile: pyproject.toml
plugins: asyncio-1.3.0, mock-3.15.1, anyio-3.7.1, cov-7.0.0, timeout-2.4.0, Faker-39.0.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
timeout: 300.0s
timeout method: thread
timeout func_only: False
collecting ... collected 147 items

tests/unit/test_auth.py::TestUserRegistration::test_register_new_user FAILED [  0%]
tests/unit/test_auth.py::TestUserRegistration::test_register_duplicate_email PASSED [  1%]
tests/unit/test_auth.py::TestUserRegistration::test_register_invalid_email PASSED [  2%]
tests/unit/test_auth.py::TestUserRegistration::test_register_weak_password PASSED [  2%]
tests/unit/test_auth.py::TestUserLogin::test_login_success PASSED        [  3%]
tests/unit/test_auth.py::TestUserLogin::test_login_wrong_password PASSED [  4%]
tests/unit/test_auth.py::TestUserLogin::test_login_nonexistent_user PASSED [  4%]
tests/unit/test_auth.py::TestUserLogin::test_login_unverified_user PASSED [  5%]
tests/unit/test_auth.py::TestTokenRefresh::test_refresh_token_success PASSED [  6%]
tests/unit/test_auth.py::TestTokenRefresh::test_refresh_token_unauthorized FAILED [  6%]
tests/unit/test_auth.py::TestEmailVerification::test_verify_email_success PASSED [  7%]
tests/unit/test_auth.py::TestEmailVerification::test_verify_email_invalid_token PASSED [  8%]
tests/unit/test_auth.py::TestEmailVerification::test_verify_email_expired_token PASSED [  8%]
tests/unit/test_auth.py::TestEmailVerification::test_resend_verification_email PASSED [  9%]
tests/unit/test_auth.py::TestEmailVerification::test_resend_verification_already_verified PASSED [ 10%]
tests/unit/test_auth.py::TestEmailVerification::test_resend_verification_nonexistent_email PASSED [ 10%]
tests/unit/test_auth.py::TestPasswordReset::test_forgot_password_success PASSED [ 11%]
tests/unit/test_auth.py::TestPasswordReset::test_forgot_password_nonexistent_email PASSED [ 12%]
tests/unit/test_auth.py::TestPasswordReset::test_reset_password_success PASSED [ 12%]
tests/unit/test_auth.py::TestPasswordReset::test_reset_password_invalid_token PASSED [ 13%]
tests/unit/test_auth.py::TestPasswordReset::test_reset_password_expired_token PASSED [ 14%]
tests/unit/test_auth.py::TestUserInfo::test_get_current_user_info PASSED [ 14%]
tests/unit/test_auth.py::TestUserInfo::test_get_current_user_info_unauthorized PASSED [ 15%]
tests/unit/test_auth.py::TestUserInfo::test_logout PASSED                [ 16%]
tests/unit/test_auth.py::TestUserInfo::test_delete_account PASSED        [ 17%]
tests/unit/test_auth.py::TestUserInfo::test_delete_account_unverified PASSED [ 17%]
tests/unit/test_auth.py::TestLoginEdgeCases::test_login_inactive_user PASSED [ 18%]
tests/unit/test_auth.py::TestLoginEdgeCases::test_login_case_sensitive_email PASSED [ 19%]
tests/unit/test_auth.py::TestLoginEdgeCases::test_refresh_token_with_inactive_user PASSED [ 19%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_expired_access_token PASSED [ 20%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_expired_refresh_token PASSED [ 21%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_malformed_token PASSED [ 21%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_token_without_bearer_prefix PASSED [ 22%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_access_token_as_refresh_token FAILED [ 23%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_refresh_token_as_access_token FAILED [ 23%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_token_with_invalid_user_id PASSED [ 24%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_token_without_sub_claim PASSED [ 25%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_token_with_non_numeric_sub PASSED [ 25%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_empty_token PASSED [ 26%]
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_token_after_user_deletion PASSED [ 27%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_minimum_length PASSED [ 27%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_too_short PASSED [ 28%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_no_digit PASSED [ 29%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_no_uppercase PASSED [ 29%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_no_lowercase PASSED [ 30%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_no_special_char PASSED [ 31%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_all_requirements PASSED [ 31%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_unicode_characters PASSED [ 32%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_very_long PASSED [ 33%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_empty_string PASSED [ 34%]
tests/unit/test_auth_edge_cases.py::TestPasswordValidationEdgeCases::test_password_strength_only_special_chars PASSED [ 34%]
tests/unit/test_auth_edge_cases.py::TestPasswordHashingEdgeCases::test_hash_and_verify_same_password PASSED [ 35%]
tests/unit/test_auth_edge_cases.py::TestPasswordHashingEdgeCases::test_verify_wrong_password PASSED [ 36%]
tests/unit/test_auth_edge_cases.py::TestPasswordHashingEdgeCases::test_verify_empty_password PASSED [ 36%]
tests/unit/test_auth_edge_cases.py::TestPasswordHashingEdgeCases::test_hash_empty_password PASSED [ 37%]
tests/unit/test_auth_edge_cases.py::TestVerificationTokenEdgeCases::test_verification_token_uniqueness PASSED [ 38%]
tests/unit/test_auth_edge_cases.py::TestVerificationTokenEdgeCases::test_verification_token_length PASSED [ 38%]
tests/unit/test_auth_edge_cases.py::TestVerificationTokenEdgeCases::test_verification_token_url_safe PASSED [ 39%]
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_login_with_empty_email PASSED [ 40%]
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_login_with_empty_password PASSED [ 40%]
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_register_with_empty_fields PASSED [ 41%]
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_register_with_very_long_email PASSED [ 42%]
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_register_with_sql_injection_attempt PASSED [ 42%]
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_register_with_xss_attempt PASSED [ 43%]
tests/unit/test_model_runner.py::TestModelRunnerMockMode::test_call_openrouter_streaming_mock_mode PASSED [ 44%]
tests/unit/test_model_runner_edge_cases.py::TestStreamingErrorHandling::test_streaming_connection_error PASSED [ 44%]
tests/unit/test_model_runner_edge_cases.py::TestStreamingErrorHandling::test_streaming_timeout_error PASSED [ 45%]
tests/unit/test_model_runner_edge_cases.py::TestStreamingErrorHandling::test_streaming_empty_response PASSED [ 46%]
tests/unit/test_model_runner_edge_cases.py::TestCleanModelResponse::test_clean_normal_response PASSED [ 46%]
tests/unit/test_model_runner_edge_cases.py::TestCleanModelResponse::test_clean_response_with_whitespace PASSED [ 47%]
tests/unit/test_model_runner_edge_cases.py::TestCleanModelResponse::test_clean_empty_response PASSED [ 48%]
tests/unit/test_model_runner_edge_cases.py::TestCleanModelResponse::test_clean_error_response PASSED [ 48%]
tests/unit/test_model_runner_edge_cases.py::TestCleanModelResponse::test_clean_response_with_special_chars PASSED [ 49%]
tests/unit/test_rate_limiting.py::TestUserCreditLimiting::test_free_tier_credits PASSED [ 50%]
tests/unit/test_rate_limiting.py::TestUserCreditLimiting::test_premium_tier_credits PASSED [ 51%]
tests/unit/test_rate_limiting.py::TestUserCreditLimiting::test_credits_exceeded FAILED [ 51%]
tests/unit/test_rate_limiting.py::TestUserCreditLimiting::test_deduct_user_credits PASSED [ 52%]
tests/unit/test_rate_limiting.py::TestAnonymousCreditLimiting::test_anonymous_credit_check PASSED [ 53%]
tests/unit/test_rate_limiting.py::TestAnonymousCreditLimiting::test_anonymous_credits_exceeded PASSED [ 53%]
tests/unit/test_rate_limiting.py::TestAnonymousCreditLimiting::test_deduct_anonymous_credits PASSED [ 54%]
tests/unit/test_rate_limiting.py::TestCreditLimitEdgeCases::test_credits_with_nonexistent_user PASSED [ 55%]
tests/unit/test_rate_limiting.py::TestCreditLimitEdgeCases::test_credits_with_invalid_tier PASSED [ 55%]
tests/unit/test_rate_limiting.py::TestCreditLimitEdgeCases::test_concurrent_credit_checks PASSED [ 56%]
tests/unit/test_rate_limiting.py::TestAllTierCredits::test_free_tier_credits PASSED [ 57%]
tests/unit/test_rate_limiting.py::TestAllTierCredits::test_starter_tier_credits PASSED [ 57%]
tests/unit/test_rate_limiting.py::TestAllTierCredits::test_starter_plus_tier_credits PASSED [ 58%]
tests/unit/test_rate_limiting.py::TestAllTierCredits::test_pro_tier_credits PASSED [ 59%]
tests/unit/test_rate_limiting.py::TestAllTierCredits::test_pro_plus_tier_credits PASSED [ 59%]
tests/unit/test_rate_limiting.py::TestAllTierCredits::test_free_tier_exceeds_credits FAILED [ 60%]
tests/unit/test_rate_limiting.py::TestAllTierCredits::test_starter_tier_exceeds_credits FAILED [ 61%]
tests/unit/test_rate_limiting.py::TestAllTierCredits::test_pro_tier_exceeds_credits FAILED [ 61%]
tests/unit/test_rate_limiting.py::TestUsageStats::test_user_usage_stats PASSED [ 62%]
tests/unit/test_rate_limiting.py::TestUsageStats::test_anonymous_usage_stats PASSED [ 63%]
tests/unit/test_rate_limiting.py::TestAnonymousCreditEdgeCases::test_anonymous_multiple_identifiers PASSED [ 63%]
tests/unit/test_rate_limiting.py::TestAnonymousCreditEdgeCases::test_anonymous_credits_reset_on_new_day PASSED [ 64%]
tests/unit/test_rate_limiting_edge_cases.py::TestUserCreditBoundaries::test_credits_at_exact_limit FAILED [ 65%]
tests/unit/test_rate_limiting_edge_cases.py::TestUserCreditBoundaries::test_credits_one_below_limit FAILED [ 65%]
tests/unit/test_rate_limiting_edge_cases.py::TestUserCreditBoundaries::test_credits_one_above_limit FAILED [ 66%]
tests/unit/test_rate_limiting_edge_cases.py::TestUserCreditBoundaries::test_credits_zero_usage PASSED [ 67%]
tests/unit/test_rate_limiting_edge_cases.py::TestCreditReset::test_reset_on_new_day PASSED [ 68%]
tests/unit/test_rate_limiting_edge_cases.py::TestCreditReset::test_no_reset_same_day FAILED [ 68%]
tests/unit/test_rate_limiting_edge_cases.py::TestDeductCredits::test_deduct_by_one PASSED [ 69%]
tests/unit/test_rate_limiting_edge_cases.py::TestDeductCredits::test_deduct_by_multiple FAILED [ 70%]
tests/unit/test_rate_limiting_edge_cases.py::TestDeductCredits::test_deduct_zero PASSED [ 70%]
tests/unit/test_rate_limiting_edge_cases.py::TestDeductCredits::test_deduct_more_than_allocated PASSED [ 71%]
tests/unit/test_rate_limiting_edge_cases.py::TestAnonymousCreditBoundaries::test_anonymous_at_limit PASSED [ 72%]
tests/unit/test_rate_limiting_edge_cases.py::TestAnonymousCreditBoundaries::test_anonymous_one_below_limit FAILED [ 72%]
tests/unit/test_rate_limiting_edge_cases.py::TestAnonymousCreditBoundaries::test_anonymous_reset_on_new_day PASSED [ 73%]
tests/unit/test_rate_limiting_edge_cases.py::TestUsageStats::test_usage_stats_at_limit FAILED [ 74%]
tests/unit/test_rate_limiting_edge_cases.py::TestUsageStats::test_usage_stats_zero_usage PASSED [ 74%]
tests/unit/test_rate_limiting_edge_cases.py::TestUsageStats::test_anonymous_usage_stats PASSED [ 75%]
tests/unit/test_rate_limiting_edge_cases.py::TestConcurrentAccess::test_concurrent_deduction PASSED [ 76%]
tests/unit/test_rate_limiting_edge_cases.py::TestDifferentSubscriptionTiers::test_free_tier_credits PASSED [ 76%]
tests/unit/test_rate_limiting_edge_cases.py::TestDifferentSubscriptionTiers::test_starter_tier_credits PASSED [ 77%]
tests/unit/test_rate_limiting_edge_cases.py::TestDifferentSubscriptionTiers::test_pro_tier_credits PASSED [ 78%]
tests/unit/test_rate_limiting_edge_cases.py::TestDifferentSubscriptionTiers::test_pro_plus_tier_credits PASSED [ 78%]
tests/unit/test_rate_limiting_edge_cases.py::TestDifferentSubscriptionTiers::test_tier_hierarchy PASSED [ 79%]
tests/unit/test_search_providers.py::TestSearchResult::test_search_result_creation PASSED [ 80%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_provider_initialization PASSED [ 80%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_get_provider_name PASSED [ 81%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_is_available_with_api_key PASSED [ 82%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_is_available_without_api_key PASSED [ 82%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_search_success PASSED [ 83%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_search_with_custom_max_results PASSED [ 84%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_search_api_error PASSED [ 85%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_search_network_error PASSED [ 85%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_search_empty_results PASSED [ 86%]
tests/unit/test_search_providers.py::TestBraveSearchProvider::test_search_missing_fields PASSED [ 87%]
tests/unit/test_search_providers.py::TestSearchProviderFactory::test_get_available_providers PASSED [ 87%]
tests/unit/test_search_providers.py::TestSearchProviderFactory::test_get_available_providers_none PASSED [ 88%]
tests/unit/test_search_providers.py::TestSearchProviderFactory::test_get_provider_brave PASSED [ 89%]
tests/unit/test_search_providers.py::TestSearchProviderFactory::test_get_provider_no_api_key PASSED [ 89%]
tests/unit/test_search_providers.py::TestSearchProviderFactory::test_get_provider_unknown PASSED [ 90%]
tests/unit/test_search_providers.py::TestSearchProviderFactory::test_get_active_provider PASSED [ 91%]
tests/unit/test_search_providers.py::TestSearchProviderFactory::test_get_active_provider_none_configured PASSED [ 91%]
tests/unit/test_search_providers.py::TestSearchProviderFactory::test_get_active_provider_no_settings PASSED [ 92%]
tests/unit/test_utils.py::TestDateUtilities::test_date_formatting PASSED [ 93%]
tests/unit/test_utils.py::TestDateUtilities::test_time_delta_calculations PASSED [ 93%]
tests/unit/test_utils.py::TestValidationUtilities::test_email_validation PASSED [ 94%]
tests/unit/test_utils.py::TestValidationUtilities::test_password_validation PASSED [ 95%]
tests/unit/test_utils.py::TestFormattingUtilities::test_number_formatting PASSED [ 95%]
tests/unit/test_utils.py::TestFormattingUtilities::test_string_formatting PASSED [ 96%]
tests/unit/test_utils.py::TestHashUtilities::test_password_hashing PASSED [ 97%]
tests/unit/test_utils.py::TestHashUtilities::test_fingerprint_hashing PASSED [ 97%]
tests/unit/test_utils.py::TestErrorHandling::test_error_formatting PASSED [ 98%]
tests/unit/test_utils.py::TestErrorHandling::test_exception_handling PASSED [ 99%]
tests/unit/test_utils.py::TestConstants::test_extended_tier_limits_exist FAILED [100%]

=================================== FAILURES ===================================
_________________ TestUserRegistration.test_register_new_user __________________
tests/unit/test_auth.py:28: in test_register_new_user
    assert response.status_code == status.HTTP_201_CREATED
E   assert 400 == 201
E    +  where 400 = <Response [400 Bad Request]>.status_code
E    +  and   201 = status.HTTP_201_CREATED
---------------------------- Captured stderr setup -----------------------------
2026-01-05 00:38:54 - app.main - INFO - Validating configuration...
2026-01-05 00:38:54 - app.config.validation - INFO - Configuration validation passed successfully
2026-01-05 00:38:54 - app.config.validation - INFO - ================================================================================
2026-01-05 00:38:54 - app.config.validation - INFO - Application Configuration
2026-01-05 00:38:54 - app.config.validation - INFO - ================================================================================
2026-01-05 00:38:54 - app.config.validation - INFO - Environment: development
2026-01-05 00:38:54 - app.config.validation - INFO - Frontend URL: http://localhost:5173
2026-01-05 00:38:54 - app.config.validation - INFO - Database URL: sqlite:///./data/compareintel.db
2026-01-05 00:38:54 - app.config.validation - INFO - Secret Key: test...hars
2026-01-05 00:38:54 - app.config.validation - INFO - OpenRouter API Key: test...only
2026-01-05 00:38:54 - app.config.validation - INFO - Email Configuration: (not configured)
2026-01-05 00:38:54 - app.config.validation - INFO - Performance Settings:
2026-01-05 00:38:54 - app.config.validation - INFO -   Individual Model Timeout: 120s
2026-01-05 00:38:54 - app.config.validation - INFO -   Model Inactivity Timeout: 55s
2026-01-05 00:38:54 - app.config.validation - INFO - Subscription Tiers:
2026-01-05 00:38:54 - app.config.validation - INFO -   free: 20 daily, 3 models/comparison, overage: False
2026-01-05 00:38:54 - app.config.validation - INFO -   starter: 50 daily, 6 models/comparison, overage: True
2026-01-05 00:38:54 - app.config.validation - INFO -   starter_plus: 100 daily, 6 models/comparison, overage: True
2026-01-05 00:38:54 - app.config.validation - INFO -   pro: 200 daily, 9 models/comparison, overage: True
2026-01-05 00:38:54 - app.config.validation - INFO -   pro_plus: 400 daily, 12 models/comparison, overage: True
2026-01-05 00:38:54 - app.config.validation - INFO - ================================================================================
2026-01-05 00:38:54 - app.main - INFO - Initializing database tables (development mode)...
2026-01-05 00:38:54 - app.main - INFO - Database initialization complete
2026-01-05 00:38:54 - app.main - INFO - Preloading model token limits...
2026-01-05 00:38:54 - app.model_runner - INFO - Preloading model token limits from OpenRouter...
2026-01-05 00:38:54 - httpx - INFO - HTTP Request: GET https://openrouter.ai/api/v1/models "HTTP/1.1 200 OK"
2026-01-05 00:38:54 - app.model_runner - INFO - Preloaded token limits for 68 configured models
2026-01-05 00:38:54 - app.model_runner - INFO - Skipped 1 model(s) not available from OpenRouter: x-ai/grok-5
2026-01-05 00:38:54 - app.main - INFO - Initializing search rate limiter...
2026-01-05 00:38:54 - app.search.distributed_rate_limiter - INFO - âœ… Redis client created - will test connection on first use
2026-01-05 00:38:54 - app.search.rate_limiter - INFO - ðŸš€ Initialized DISTRIBUTED search rate limiter with Redis: 3 req/min, 2 concurrent, 3.0s delay. Cache: enabled. Circuit breaker: enabled.
2026-01-05 00:38:54 - app.main - INFO - Search rate limiter initialized successfully
2026-01-05 00:38:54 - app.main - INFO - Application startup complete
------------------------------ Captured log setup ------------------------------
INFO     app.main:main.py:81 Validating configuration...
INFO     app.config.validation:validation.py:184 Configuration validation passed successfully
INFO     app.config.validation:validation.py:211 ================================================================================
INFO     app.config.validation:validation.py:212 Application Configuration
INFO     app.config.validation:validation.py:213 ================================================================================
INFO     app.config.validation:validation.py:216 Environment: development
INFO     app.config.validation:validation.py:217 Frontend URL: http://localhost:5173
INFO     app.config.validation:validation.py:235 Database URL: sqlite:///./data/compareintel.db
INFO     app.config.validation:validation.py:238 Secret Key: test...hars
INFO     app.config.validation:validation.py:241 OpenRouter API Key: test...only
INFO     app.config.validation:validation.py:252 Email Configuration: (not configured)
INFO     app.config.validation:validation.py:255 Performance Settings:
INFO     app.config.validation:validation.py:256   Individual Model Timeout: 120s
INFO     app.config.validation:validation.py:257   Model Inactivity Timeout: 55s
INFO     app.config.validation:validation.py:260 Subscription Tiers:
INFO     app.config.validation:validation.py:262   free: 20 daily, 3 models/comparison, overage: False
INFO     app.config.validation:validation.py:262   starter: 50 daily, 6 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   starter_plus: 100 daily, 6 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   pro: 200 daily, 9 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   pro_plus: 400 daily, 12 models/comparison, overage: True
INFO     app.config.validation:validation.py:270 ================================================================================
INFO     app.main:main.py:90 Initializing database tables (development mode)...
INFO     app.main:main.py:92 Database initialization complete
INFO     app.main:main.py:97 Preloading model token limits...
INFO     app.model_runner:model_runner.py:934 Preloading model token limits from OpenRouter...
INFO     httpx:_client.py:1025 HTTP Request: GET https://openrouter.ai/api/v1/models "HTTP/1.1 200 OK"
INFO     app.model_runner:model_runner.py:950 Preloaded token limits for 68 configured models
INFO     app.model_runner:model_runner.py:952 Skipped 1 model(s) not available from OpenRouter: x-ai/grok-5
INFO     app.main:main.py:101 Initializing search rate limiter...
INFO     app.search.distributed_rate_limiter:distributed_rate_limiter.py:431 âœ… Redis client created - will test connection on first use
INFO     app.search.rate_limiter:rate_limiter.py:335 ðŸš€ Initialized DISTRIBUTED search rate limiter with Redis: 3 req/min, 2 concurrent, 3.0s delay. Cache: enabled. Circuit breaker: enabled.
INFO     app.main:main.py:104 Search rate limiter initialized successfully
INFO     app.main:main.py:106 Application startup complete
----------------------------- Captured stderr call -----------------------------
2026-01-05 00:38:54 - app.routers.auth - WARNING - reCAPTCHA verification failed: token not provided (reCAPTCHA is configured)
2026-01-05 00:38:54 - httpx - INFO - HTTP Request: POST http://testserver/api/auth/register "HTTP/1.1 400 Bad Request"
------------------------------ Captured log call -------------------------------
WARNING  app.routers.auth:auth.py:118 reCAPTCHA verification failed: token not provided (reCAPTCHA is configured)
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/auth/register "HTTP/1.1 400 Bad Request"
_______________ TestTokenRefresh.test_refresh_token_unauthorized _______________
tests/unit/test_auth.py:169: in test_refresh_token_unauthorized
    assert response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY
E   assert 401 == 422
E    +  where 401 = <Response [401 Unauthorized]>.status_code
E    +  and   422 = status.HTTP_422_UNPROCESSABLE_ENTITY
---------------------------- Captured stderr setup -----------------------------
2026-01-05 00:38:59 - app.main - INFO - Validating configuration...
2026-01-05 00:38:59 - app.config.validation - INFO - Configuration validation passed successfully
2026-01-05 00:38:59 - app.config.validation - INFO - ================================================================================
2026-01-05 00:38:59 - app.config.validation - INFO - Application Configuration
2026-01-05 00:38:59 - app.config.validation - INFO - ================================================================================
2026-01-05 00:38:59 - app.config.validation - INFO - Environment: development
2026-01-05 00:38:59 - app.config.validation - INFO - Frontend URL: http://localhost:5173
2026-01-05 00:38:59 - app.config.validation - INFO - Database URL: sqlite:///./data/compareintel.db
2026-01-05 00:38:59 - app.config.validation - INFO - Secret Key: test...hars
2026-01-05 00:38:59 - app.config.validation - INFO - OpenRouter API Key: test...only
2026-01-05 00:38:59 - app.config.validation - INFO - Email Configuration: (not configured)
2026-01-05 00:38:59 - app.config.validation - INFO - Performance Settings:
2026-01-05 00:38:59 - app.config.validation - INFO -   Individual Model Timeout: 120s
2026-01-05 00:38:59 - app.config.validation - INFO -   Model Inactivity Timeout: 55s
2026-01-05 00:38:59 - app.config.validation - INFO - Subscription Tiers:
2026-01-05 00:38:59 - app.config.validation - INFO -   free: 20 daily, 3 models/comparison, overage: False
2026-01-05 00:38:59 - app.config.validation - INFO -   starter: 50 daily, 6 models/comparison, overage: True
2026-01-05 00:38:59 - app.config.validation - INFO -   starter_plus: 100 daily, 6 models/comparison, overage: True
2026-01-05 00:38:59 - app.config.validation - INFO -   pro: 200 daily, 9 models/comparison, overage: True
2026-01-05 00:38:59 - app.config.validation - INFO -   pro_plus: 400 daily, 12 models/comparison, overage: True
2026-01-05 00:38:59 - app.config.validation - INFO - ================================================================================
2026-01-05 00:38:59 - app.main - INFO - Initializing database tables (development mode)...
2026-01-05 00:38:59 - app.main - INFO - Database initialization complete
2026-01-05 00:38:59 - app.main - INFO - Preloading model token limits...
2026-01-05 00:38:59 - app.model_runner - INFO - Preloading model token limits from OpenRouter...
2026-01-05 00:38:59 - httpx - INFO - HTTP Request: GET https://openrouter.ai/api/v1/models "HTTP/1.1 200 OK"
2026-01-05 00:38:59 - app.model_runner - INFO - Preloaded token limits for 68 configured models
2026-01-05 00:38:59 - app.model_runner - INFO - Skipped 1 model(s) not available from OpenRouter: x-ai/grok-5
2026-01-05 00:38:59 - app.main - INFO - Initializing search rate limiter...
2026-01-05 00:38:59 - app.main - INFO - Search rate limiter initialized successfully
2026-01-05 00:38:59 - app.main - INFO - Application startup complete
------------------------------ Captured log setup ------------------------------
INFO     app.main:main.py:81 Validating configuration...
INFO     app.config.validation:validation.py:184 Configuration validation passed successfully
INFO     app.config.validation:validation.py:211 ================================================================================
INFO     app.config.validation:validation.py:212 Application Configuration
INFO     app.config.validation:validation.py:213 ================================================================================
INFO     app.config.validation:validation.py:216 Environment: development
INFO     app.config.validation:validation.py:217 Frontend URL: http://localhost:5173
INFO     app.config.validation:validation.py:235 Database URL: sqlite:///./data/compareintel.db
INFO     app.config.validation:validation.py:238 Secret Key: test...hars
INFO     app.config.validation:validation.py:241 OpenRouter API Key: test...only
INFO     app.config.validation:validation.py:252 Email Configuration: (not configured)
INFO     app.config.validation:validation.py:255 Performance Settings:
INFO     app.config.validation:validation.py:256   Individual Model Timeout: 120s
INFO     app.config.validation:validation.py:257   Model Inactivity Timeout: 55s
INFO     app.config.validation:validation.py:260 Subscription Tiers:
INFO     app.config.validation:validation.py:262   free: 20 daily, 3 models/comparison, overage: False
INFO     app.config.validation:validation.py:262   starter: 50 daily, 6 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   starter_plus: 100 daily, 6 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   pro: 200 daily, 9 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   pro_plus: 400 daily, 12 models/comparison, overage: True
INFO     app.config.validation:validation.py:270 ================================================================================
INFO     app.main:main.py:90 Initializing database tables (development mode)...
INFO     app.main:main.py:92 Database initialization complete
INFO     app.main:main.py:97 Preloading model token limits...
INFO     app.model_runner:model_runner.py:934 Preloading model token limits from OpenRouter...
INFO     httpx:_client.py:1025 HTTP Request: GET https://openrouter.ai/api/v1/models "HTTP/1.1 200 OK"
INFO     app.model_runner:model_runner.py:950 Preloaded token limits for 68 configured models
INFO     app.model_runner:model_runner.py:952 Skipped 1 model(s) not available from OpenRouter: x-ai/grok-5
INFO     app.main:main.py:101 Initializing search rate limiter...
INFO     app.main:main.py:104 Search rate limiter initialized successfully
INFO     app.main:main.py:106 Application startup complete
----------------------------- Captured stderr call -----------------------------
2026-01-05 00:38:59 - httpx - INFO - HTTP Request: POST http://testserver/api/auth/refresh "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/auth/refresh "HTTP/1.1 401 Unauthorized"
____________ TestTokenEdgeCases.test_access_token_as_refresh_token _____________
tests/unit/test_auth_edge_cases.py:93: in test_access_token_as_refresh_token
    assert response.status_code == status.HTTP_401_UNAUTHORIZED
E   assert 200 == 401
E    +  where 200 = <Response [200 OK]>.status_code
E    +  and   401 = status.HTTP_401_UNAUTHORIZED
---------------------------- Captured stdout setup -----------------------------
[LOGIN] Login request received at 2026-01-05 00:39:14
[LOGIN] Email: test@example.com
[LOGIN] Client IP: testclient
[LOGIN] Checking rate limit...
[LOGIN] Rate limit check passed
[LOGIN] Querying database for user...
[LOGIN] Database query completed in 0.002s
[LOGIN] User found: test@example.com, verifying password...
[LOGIN] Password verification completed in 0.234s, result: True
[LOGIN] Creating tokens...
[LOGIN] Token creation completed in 0.001s
[LOGIN] Login successful, total time: 0.240s
---------------------------- Captured stderr setup -----------------------------
2026-01-05 00:39:14 - app.main - INFO - Validating configuration...
2026-01-05 00:39:14 - app.config.validation - INFO - Configuration validation passed successfully
2026-01-05 00:39:14 - app.config.validation - INFO - ================================================================================
2026-01-05 00:39:14 - app.config.validation - INFO - Application Configuration
2026-01-05 00:39:14 - app.config.validation - INFO - ================================================================================
2026-01-05 00:39:14 - app.config.validation - INFO - Environment: development
2026-01-05 00:39:14 - app.config.validation - INFO - Frontend URL: http://localhost:5173
2026-01-05 00:39:14 - app.config.validation - INFO - Database URL: sqlite:///./data/compareintel.db
2026-01-05 00:39:14 - app.config.validation - INFO - Secret Key: test...hars
2026-01-05 00:39:14 - app.config.validation - INFO - OpenRouter API Key: test...only
2026-01-05 00:39:14 - app.config.validation - INFO - Email Configuration: (not configured)
2026-01-05 00:39:14 - app.config.validation - INFO - Performance Settings:
2026-01-05 00:39:14 - app.config.validation - INFO -   Individual Model Timeout: 120s
2026-01-05 00:39:14 - app.config.validation - INFO -   Model Inactivity Timeout: 55s
2026-01-05 00:39:14 - app.config.validation - INFO - Subscription Tiers:
2026-01-05 00:39:14 - app.config.validation - INFO -   free: 20 daily, 3 models/comparison, overage: False
2026-01-05 00:39:14 - app.config.validation - INFO -   starter: 50 daily, 6 models/comparison, overage: True
2026-01-05 00:39:14 - app.config.validation - INFO -   starter_plus: 100 daily, 6 models/comparison, overage: True
2026-01-05 00:39:14 - app.config.validation - INFO -   pro: 200 daily, 9 models/comparison, overage: True
2026-01-05 00:39:14 - app.config.validation - INFO -   pro_plus: 400 daily, 12 models/comparison, overage: True
2026-01-05 00:39:14 - app.config.validation - INFO - ================================================================================
2026-01-05 00:39:14 - app.main - INFO - Initializing database tables (development mode)...
2026-01-05 00:39:14 - app.main - INFO - Database initialization complete
2026-01-05 00:39:14 - app.main - INFO - Preloading model token limits...
2026-01-05 00:39:14 - app.model_runner - INFO - Preloading model token limits from OpenRouter...
2026-01-05 00:39:14 - httpx - INFO - HTTP Request: GET https://openrouter.ai/api/v1/models "HTTP/1.1 200 OK"
2026-01-05 00:39:14 - app.model_runner - INFO - Preloaded token limits for 68 configured models
2026-01-05 00:39:14 - app.model_runner - INFO - Skipped 1 model(s) not available from OpenRouter: x-ai/grok-5
2026-01-05 00:39:14 - app.main - INFO - Initializing search rate limiter...
2026-01-05 00:39:14 - app.main - INFO - Search rate limiter initialized successfully
2026-01-05 00:39:14 - app.main - INFO - Application startup complete
2026-01-05 00:39:15 - httpx - INFO - HTTP Request: POST http://testserver/api/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     app.main:main.py:81 Validating configuration...
INFO     app.config.validation:validation.py:184 Configuration validation passed successfully
INFO     app.config.validation:validation.py:211 ================================================================================
INFO     app.config.validation:validation.py:212 Application Configuration
INFO     app.config.validation:validation.py:213 ================================================================================
INFO     app.config.validation:validation.py:216 Environment: development
INFO     app.config.validation:validation.py:217 Frontend URL: http://localhost:5173
INFO     app.config.validation:validation.py:235 Database URL: sqlite:///./data/compareintel.db
INFO     app.config.validation:validation.py:238 Secret Key: test...hars
INFO     app.config.validation:validation.py:241 OpenRouter API Key: test...only
INFO     app.config.validation:validation.py:252 Email Configuration: (not configured)
INFO     app.config.validation:validation.py:255 Performance Settings:
INFO     app.config.validation:validation.py:256   Individual Model Timeout: 120s
INFO     app.config.validation:validation.py:257   Model Inactivity Timeout: 55s
INFO     app.config.validation:validation.py:260 Subscription Tiers:
INFO     app.config.validation:validation.py:262   free: 20 daily, 3 models/comparison, overage: False
INFO     app.config.validation:validation.py:262   starter: 50 daily, 6 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   starter_plus: 100 daily, 6 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   pro: 200 daily, 9 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   pro_plus: 400 daily, 12 models/comparison, overage: True
INFO     app.config.validation:validation.py:270 ================================================================================
INFO     app.main:main.py:90 Initializing database tables (development mode)...
INFO     app.main:main.py:92 Database initialization complete
INFO     app.main:main.py:97 Preloading model token limits...
INFO     app.model_runner:model_runner.py:934 Preloading model token limits from OpenRouter...
INFO     httpx:_client.py:1025 HTTP Request: GET https://openrouter.ai/api/v1/models "HTTP/1.1 200 OK"
INFO     app.model_runner:model_runner.py:950 Preloaded token limits for 68 configured models
INFO     app.model_runner:model_runner.py:952 Skipped 1 model(s) not available from OpenRouter: x-ai/grok-5
INFO     app.main:main.py:101 Initializing search rate limiter...
INFO     app.main:main.py:104 Search rate limiter initialized successfully
INFO     app.main:main.py:106 Application startup complete
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/auth/login "HTTP/1.1 200 OK"
----------------------------- Captured stderr call -----------------------------
2026-01-05 00:39:15 - httpx - INFO - HTTP Request: POST http://testserver/api/auth/refresh "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/auth/refresh "HTTP/1.1 200 OK"
____________ TestTokenEdgeCases.test_refresh_token_as_access_token _____________
tests/unit/test_auth_edge_cases.py:102: in test_refresh_token_as_access_token
    assert response.status_code == status.HTTP_401_UNAUTHORIZED
E   assert 200 == 401
E    +  where 200 = <Response [200 OK]>.status_code
E    +  and   401 = status.HTTP_401_UNAUTHORIZED
---------------------------- Captured stdout setup -----------------------------
[LOGIN] Login request received at 2026-01-05 00:39:15
[LOGIN] Email: test@example.com
[LOGIN] Client IP: testclient
[LOGIN] Checking rate limit...
[LOGIN] Rate limit check passed
[LOGIN] Querying database for user...
[LOGIN] Database query completed in 0.001s
[LOGIN] User found: test@example.com, verifying password...
[LOGIN] Password verification completed in 0.250s, result: True
[LOGIN] Creating tokens...
[LOGIN] Token creation completed in 0.001s
[LOGIN] Login successful, total time: 0.254s
---------------------------- Captured stderr setup -----------------------------
2026-01-05 00:39:15 - app.main - INFO - Validating configuration...
2026-01-05 00:39:15 - app.config.validation - INFO - Configuration validation passed successfully
2026-01-05 00:39:15 - app.config.validation - INFO - ================================================================================
2026-01-05 00:39:15 - app.config.validation - INFO - Application Configuration
2026-01-05 00:39:15 - app.config.validation - INFO - ================================================================================
2026-01-05 00:39:15 - app.config.validation - INFO - Environment: development
2026-01-05 00:39:15 - app.config.validation - INFO - Frontend URL: http://localhost:5173
2026-01-05 00:39:15 - app.config.validation - INFO - Database URL: sqlite:///./data/compareintel.db
2026-01-05 00:39:15 - app.config.validation - INFO - Secret Key: test...hars
2026-01-05 00:39:15 - app.config.validation - INFO - OpenRouter API Key: test...only
2026-01-05 00:39:15 - app.config.validation - INFO - Email Configuration: (not configured)
2026-01-05 00:39:15 - app.config.validation - INFO - Performance Settings:
2026-01-05 00:39:15 - app.config.validation - INFO -   Individual Model Timeout: 120s
2026-01-05 00:39:15 - app.config.validation - INFO -   Model Inactivity Timeout: 55s
2026-01-05 00:39:15 - app.config.validation - INFO - Subscription Tiers:
2026-01-05 00:39:15 - app.config.validation - INFO -   free: 20 daily, 3 models/comparison, overage: False
2026-01-05 00:39:15 - app.config.validation - INFO -   starter: 50 daily, 6 models/comparison, overage: True
2026-01-05 00:39:15 - app.config.validation - INFO -   starter_plus: 100 daily, 6 models/comparison, overage: True
2026-01-05 00:39:15 - app.config.validation - INFO -   pro: 200 daily, 9 models/comparison, overage: True
2026-01-05 00:39:15 - app.config.validation - INFO -   pro_plus: 400 daily, 12 models/comparison, overage: True
2026-01-05 00:39:15 - app.config.validation - INFO - ================================================================================
2026-01-05 00:39:15 - app.main - INFO - Initializing database tables (development mode)...
2026-01-05 00:39:15 - app.main - INFO - Database initialization complete
2026-01-05 00:39:15 - app.main - INFO - Preloading model token limits...
2026-01-05 00:39:15 - app.model_runner - INFO - Preloading model token limits from OpenRouter...
2026-01-05 00:39:15 - httpx - INFO - HTTP Request: GET https://openrouter.ai/api/v1/models "HTTP/1.1 200 OK"
2026-01-05 00:39:15 - app.model_runner - INFO - Preloaded token limits for 68 configured models
2026-01-05 00:39:15 - app.model_runner - INFO - Skipped 1 model(s) not available from OpenRouter: x-ai/grok-5
2026-01-05 00:39:15 - app.main - INFO - Initializing search rate limiter...
2026-01-05 00:39:15 - app.main - INFO - Search rate limiter initialized successfully
2026-01-05 00:39:15 - app.main - INFO - Application startup complete
2026-01-05 00:39:15 - httpx - INFO - HTTP Request: POST http://testserver/api/auth/login "HTTP/1.1 200 OK"
------------------------------ Captured log setup ------------------------------
INFO     app.main:main.py:81 Validating configuration...
INFO     app.config.validation:validation.py:184 Configuration validation passed successfully
INFO     app.config.validation:validation.py:211 ================================================================================
INFO     app.config.validation:validation.py:212 Application Configuration
INFO     app.config.validation:validation.py:213 ================================================================================
INFO     app.config.validation:validation.py:216 Environment: development
INFO     app.config.validation:validation.py:217 Frontend URL: http://localhost:5173
INFO     app.config.validation:validation.py:235 Database URL: sqlite:///./data/compareintel.db
INFO     app.config.validation:validation.py:238 Secret Key: test...hars
INFO     app.config.validation:validation.py:241 OpenRouter API Key: test...only
INFO     app.config.validation:validation.py:252 Email Configuration: (not configured)
INFO     app.config.validation:validation.py:255 Performance Settings:
INFO     app.config.validation:validation.py:256   Individual Model Timeout: 120s
INFO     app.config.validation:validation.py:257   Model Inactivity Timeout: 55s
INFO     app.config.validation:validation.py:260 Subscription Tiers:
INFO     app.config.validation:validation.py:262   free: 20 daily, 3 models/comparison, overage: False
INFO     app.config.validation:validation.py:262   starter: 50 daily, 6 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   starter_plus: 100 daily, 6 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   pro: 200 daily, 9 models/comparison, overage: True
INFO     app.config.validation:validation.py:262   pro_plus: 400 daily, 12 models/comparison, overage: True
INFO     app.config.validation:validation.py:270 ================================================================================
INFO     app.main:main.py:90 Initializing database tables (development mode)...
INFO     app.main:main.py:92 Database initialization complete
INFO     app.main:main.py:97 Preloading model token limits...
INFO     app.model_runner:model_runner.py:934 Preloading model token limits from OpenRouter...
INFO     httpx:_client.py:1025 HTTP Request: GET https://openrouter.ai/api/v1/models "HTTP/1.1 200 OK"
INFO     app.model_runner:model_runner.py:950 Preloaded token limits for 68 configured models
INFO     app.model_runner:model_runner.py:952 Skipped 1 model(s) not available from OpenRouter: x-ai/grok-5
INFO     app.main:main.py:101 Initializing search rate limiter...
INFO     app.main:main.py:104 Search rate limiter initialized successfully
INFO     app.main:main.py:106 Application startup complete
INFO     httpx:_client.py:1025 HTTP Request: POST http://testserver/api/auth/login "HTTP/1.1 200 OK"
----------------------------- Captured stdout call -----------------------------
[/auth/me] Returning user data for test@example.com: credits_used=0
----------------------------- Captured stderr call -----------------------------
2026-01-05 00:39:15 - httpx - INFO - HTTP Request: GET http://testserver/api/auth/me "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
INFO     httpx:_client.py:1025 HTTP Request: GET http://testserver/api/auth/me "HTTP/1.1 200 OK"
_________________ TestUserCreditLimiting.test_credits_exceeded _________________
tests/unit/test_rate_limiting.py:72: in test_credits_exceeded
    assert credits_remaining < required_credits
E   AssertionError: assert 100 < Decimal('5')
______________ TestAllTierCredits.test_free_tier_exceeds_credits _______________
tests/unit/test_rate_limiting.py:275: in test_free_tier_exceeds_credits
    assert is_allowed is False
E   assert True is False
_____________ TestAllTierCredits.test_starter_tier_exceeds_credits _____________
tests/unit/test_rate_limiting.py:289: in test_starter_tier_exceeds_credits
    assert is_allowed is False
E   assert True is False
_______________ TestAllTierCredits.test_pro_tier_exceeds_credits _______________
tests/unit/test_rate_limiting.py:303: in test_pro_tier_exceeds_credits
    assert is_allowed is False
E   assert True is False
_____________ TestUserCreditBoundaries.test_credits_at_exact_limit _____________
tests/unit/test_rate_limiting_edge_cases.py:44: in test_credits_at_exact_limit
    assert is_allowed is False
E   assert True is False
____________ TestUserCreditBoundaries.test_credits_one_below_limit _____________
tests/unit/test_rate_limiting_edge_cases.py:61: in test_credits_one_below_limit
    assert credits_remaining == 1
E   assert 100 == 1
____________ TestUserCreditBoundaries.test_credits_one_above_limit _____________
tests/unit/test_rate_limiting_edge_cases.py:76: in test_credits_one_above_limit
    assert is_allowed is False
E   assert True is False
____________________ TestCreditReset.test_no_reset_same_day ____________________
tests/unit/test_rate_limiting_edge_cases.py:135: in test_no_reset_same_day
    assert credits_remaining < allocated
E   assert 100 < 100
__________________ TestDeductCredits.test_deduct_by_multiple ___________________
tests/unit/test_rate_limiting_edge_cases.py:159: in test_deduct_by_multiple
    assert test_user_free.credits_used_this_period >= initial_used + 10
E   assert 0 >= (0 + 10)
E    +  where 0 = <app.models.User object at 0x755e9a807290>.credits_used_this_period
_________ TestAnonymousCreditBoundaries.test_anonymous_one_below_limit _________
tests/unit/test_rate_limiting_edge_cases.py:214: in test_anonymous_one_below_limit
    assert is_allowed is True
E   assert False is True
----------------------------- Captured stdout call -----------------------------
[DEBUG] deduct_anonymous_credits - ip:192.168.1.2: deducted 49 credits (from 49.0000), new count: 50 (capped at 50)
___________________ TestUsageStats.test_usage_stats_at_limit ___________________
tests/unit/test_rate_limiting_edge_cases.py:245: in test_usage_stats_at_limit
    from app.models import get_db
E   ImportError: cannot import name 'get_db' from 'app.models' (/home/dan_wsl/jaydeelew/CompareIntel/backend/app/models.py)
________________ TestConstants.test_extended_tier_limits_exist _________________
tests/unit/test_utils.py:155: in test_extended_tier_limits_exist
    from app.config import EXTENDED_TIER_LIMITS
E   ImportError: cannot import name 'EXTENDED_TIER_LIMITS' from 'app.config' (/home/dan_wsl/jaydeelew/CompareIntel/backend/app/config/__init__.py)
=============================== warnings summary ===============================
venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854
  /home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

tests/unit/test_auth.py::TestUserRegistration::test_register_invalid_email
tests/unit/test_auth.py::TestUserRegistration::test_register_weak_password
tests/unit/test_auth.py::TestTokenRefresh::test_refresh_token_unauthorized
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_login_with_empty_email
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_login_with_empty_password
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_register_with_empty_fields
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_register_with_very_long_email
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_register_with_sql_injection_attempt
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_register_with_xss_attempt
  /home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/_pytest/python.py:166: DeprecationWarning: 'HTTP_422_UNPROCESSABLE_ENTITY' is deprecated. Use 'HTTP_422_UNPROCESSABLE_CONTENT' instead.
    result = testfunction(**testargs)

tests/unit/test_auth.py: 12 warnings
tests/unit/test_auth_edge_cases.py: 4 warnings
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/routers/auth.py:71: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = datetime.utcnow()

tests/unit/test_auth.py: 8 warnings
tests/unit/test_auth_edge_cases.py: 3 warnings
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/routers/auth.py:311: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user.last_access = datetime.utcnow()

tests/unit/test_auth.py: 9 warnings
tests/unit/test_auth_edge_cases.py: 9 warnings
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/auth.py:86: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)

tests/unit/test_auth.py: 9 warnings
tests/unit/test_auth_edge_cases.py: 6 warnings
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/auth.py:104: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + timedelta(days=REFRESH_TOKEN_EXPIRE_DAYS)

tests/unit/test_auth.py::TestUserLogin::test_login_wrong_password
tests/unit/test_auth.py::TestUserLogin::test_login_nonexistent_user
tests/unit/test_auth.py::TestLoginEdgeCases::test_login_inactive_user
tests/unit/test_auth.py::TestLoginEdgeCases::test_login_case_sensitive_email
tests/unit/test_auth_edge_cases.py::TestAuthEdgeCases::test_login_with_empty_password
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/routers/auth.py:92: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    failed_login_attempts[client_ip].append(datetime.utcnow())

tests/unit/test_auth.py::TestEmailVerification::test_verify_email_success
  /home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_auth.py:196: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    verification_token_expires=datetime.utcnow() + timedelta(hours=24),

tests/unit/test_auth.py::TestEmailVerification::test_verify_email_success
tests/unit/test_auth.py::TestEmailVerification::test_verify_email_invalid_token
tests/unit/test_auth.py::TestEmailVerification::test_verify_email_expired_token
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/routers/auth.py:408: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    .filter(User.verification_token == verification.token, User.verification_token_expires > datetime.utcnow())

tests/unit/test_auth.py::TestEmailVerification::test_verify_email_expired_token
  /home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_auth.py:237: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    verification_token_expires=datetime.utcnow() - timedelta(hours=1),  # Expired

tests/unit/test_auth.py::TestEmailVerification::test_resend_verification_email
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/routers/auth.py:461: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user.verification_token_expires = datetime.utcnow() + timedelta(hours=24)

tests/unit/test_auth.py::TestPasswordReset::test_forgot_password_success
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/routers/auth.py:498: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user.reset_token_expires = datetime.utcnow() + timedelta(hours=1)

tests/unit/test_auth.py::TestPasswordReset::test_reset_password_success
  /home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_auth.py:319: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    reset_token_expires=datetime.utcnow() + timedelta(hours=1),

tests/unit/test_auth.py::TestPasswordReset::test_reset_password_success
tests/unit/test_auth.py::TestPasswordReset::test_reset_password_invalid_token
tests/unit/test_auth.py::TestPasswordReset::test_reset_password_expired_token
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/routers/auth.py:526: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    user = db.query(User).filter(User.reset_token == reset.token, User.reset_token_expires > datetime.utcnow()).first()

tests/unit/test_auth.py::TestPasswordReset::test_reset_password_expired_token
  /home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_auth.py:364: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    reset_token_expires=datetime.utcnow() - timedelta(hours=1),  # Expired

tests/unit/test_auth.py::TestUserInfo::test_get_current_user_info
tests/unit/test_auth.py::TestUserInfo::test_logout
tests/unit/test_auth.py::TestUserInfo::test_delete_account
tests/unit/test_auth.py::TestUserInfo::test_delete_account_unverified
tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_refresh_token_as_access_token
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/dependencies.py:136: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    if user.last_access is None or (datetime.utcnow() - user.last_access).total_seconds() > 60:

tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_expired_access_token
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/auth.py:84: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expire = datetime.utcnow() + expires_delta

tests/unit/test_rate_limiting_edge_cases.py::TestConcurrentAccess::test_concurrent_deduction
  /home/dan_wsl/jaydeelew/CompareIntel/backend/app/credit_manager.py:132: SAWarning: Usage of the 'Session.add()' operation is not currently supported within the execution stage of the flush process. Results may not be consistent.  Consider using alternative event listeners or connection-level operations instead.
    db.add(transaction)

tests/unit/test_rate_limiting_edge_cases.py::TestConcurrentAccess::test_concurrent_deduction
  /home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py:58: PytestUnhandledThreadExceptionWarning: Exception in thread Thread-116 (deduct)
  
  Traceback (most recent call last):
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
      self.dialect.do_execute(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
      cursor.execute(statement, parameters)
  sqlite3.InterfaceError: bad parameter or other API misuse
  
  The above exception was the direct cause of the following exception:
  
  Traceback (most recent call last):
    File "/usr/lib/python3.12/threading.py", line 1073, in _bootstrap_inner
      self.run()
    File "/usr/lib/python3.12/threading.py", line 1010, in run
      self._target(*self._args, **self._kwargs)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_rate_limiting_edge_cases.py", line 285, in deduct
      db_session.refresh(test_user_free)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 3154, in refresh
      loading.load_on_ident(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 510, in load_on_ident
      return load_on_pk_identity(
             ^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/loading.py", line 695, in load_on_pk_identity
      session.execute(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2351, in execute
      return self._execute_internal(
             ^^^^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2249, in _execute_internal
      result: Result[Any] = compile_state_cls.orm_execute_statement(
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/context.py", line 306, in orm_execute_statement
      result = conn.execute(
               ^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
      return meth(
             ^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 527, in _execute_on_connection
      return connection._execute_clauseelement(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
      ret = self._execute_context(
            ^^^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
      return self._exec_single_context(
             ^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
      self._handle_dbapi_exception(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2363, in _handle_dbapi_exception
      raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
      self.dialect.do_execute(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 952, in do_execute
      cursor.execute(statement, parameters)
  sqlalchemy.exc.InterfaceError: (sqlite3.InterfaceError) bad parameter or other API misuse
  [SQL: SELECT users.id, users.email, users.password_hash, users.is_verified, users.is_active, users.verification_token, users.verification_token_expires, users.reset_token, users.reset_token_expires, users.subscription_tier, users.subscription_status, users.subscription_period, users.subscription_start_date, users.subscription_end_date, users.role, users.is_admin, users.admin_permissions, users.mock_mode_enabled, users.stripe_customer_id, users.monthly_overage_count, users.overage_reset_date, users.monthly_credits_allocated, users.credits_used_this_period, users.total_credits_used, users.billing_period_start, users.billing_period_end, users.credits_reset_at, users.created_at, users.updated_at, users.last_access 
  FROM users 
  WHERE users.id = ?]
  [parameters: (1,)]
  (Background on this error at: https://sqlalche.me/e/20/rvf5)
  
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.
    warnings.warn(pytest.PytestUnhandledThreadExceptionWarning(msg))

tests/unit/test_rate_limiting_edge_cases.py::TestConcurrentAccess::test_concurrent_deduction
  /home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py:58: PytestUnhandledThreadExceptionWarning: Exception in thread Thread-117 (deduct)
  
  Traceback (most recent call last):
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
      flush_context.execute()
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
      rec.execute(self)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 679, in execute
      util.preloaded.orm_persistence.delete_obj(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 176, in delete_obj
      states_to_delete = list(
                         ^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 311, in _organize_states_for_delete
      for state, dict_, mapper, connection in _connections_for_states(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1759, in _connections_for_states
      connection = uowtransaction.transaction.connection(base_mapper)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "<string>", line 2, in connection
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
      self._raise_for_prerequisite_state(fn.__name__, current_state)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 986, in _raise_for_prerequisite_state
      raise sa_exc.ResourceClosedError("This transaction is closed")
  sqlalchemy.exc.ResourceClosedError: This transaction is closed
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "/usr/lib/python3.12/threading.py", line 1073, in _bootstrap_inner
      self.run()
    File "/usr/lib/python3.12/threading.py", line 1010, in run
      self._target(*self._args, **self._kwargs)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_rate_limiting_edge_cases.py", line 286, in deduct
      deduct_user_credits(test_user_free, Decimal("1"), None, db_session, "Concurrent test")
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/app/rate_limiting.py", line 192, in deduct_user_credits
      deduct_credits(user.id, credits, usage_log_id, db, description)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/app/credit_manager.py", line 134, in deduct_credits
      db.commit()
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
      trans.commit(_to_root=True)
    File "<string>", line 2, in commit
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
      ret_value = fn(self, *arg, **kw)
                  ^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1311, in commit
      self._prepare_impl()
    File "<string>", line 2, in _prepare_impl
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
      ret_value = fn(self, *arg, **kw)
                  ^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1286, in _prepare_impl
      self.session.flush()
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
      self._flush(objects)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
      with util.safe_reraise():
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 228, in __exit__
      raise value.with_traceback(traceback)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4467, in _flush
      transaction.rollback(_capture_exception=True)
    File "<string>", line 2, in rollback
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
      self._raise_for_prerequisite_state(fn.__name__, current_state)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 986, in _raise_for_prerequisite_state
      raise sa_exc.ResourceClosedError("This transaction is closed")
  sqlalchemy.exc.ResourceClosedError: This transaction is closed
  
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.
    warnings.warn(pytest.PytestUnhandledThreadExceptionWarning(msg))

tests/unit/test_rate_limiting_edge_cases.py::TestConcurrentAccess::test_concurrent_deduction
  /home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py:58: PytestUnhandledThreadExceptionWarning: Exception in thread Thread-113 (deduct)
  
  Traceback (most recent call last):
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4427, in _flush
      flush_context.execute()
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
      rec.execute(self)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
      util.preloaded.orm_persistence.save_obj(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 60, in save_obj
      for (
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 223, in _organize_states_for_save
      for state, dict_, mapper, connection in _connections_for_states(
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1759, in _connections_for_states
      connection = uowtransaction.transaction.connection(base_mapper)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    File "<string>", line 2, in connection
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
      self._raise_for_prerequisite_state(fn.__name__, current_state)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 986, in _raise_for_prerequisite_state
      raise sa_exc.ResourceClosedError("This transaction is closed")
  sqlalchemy.exc.ResourceClosedError: This transaction is closed
  
  During handling of the above exception, another exception occurred:
  
  Traceback (most recent call last):
    File "/usr/lib/python3.12/threading.py", line 1073, in _bootstrap_inner
      self.run()
    File "/usr/lib/python3.12/threading.py", line 1010, in run
      self._target(*self._args, **self._kwargs)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_rate_limiting_edge_cases.py", line 286, in deduct
      deduct_user_credits(test_user_free, Decimal("1"), None, db_session, "Concurrent test")
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/app/rate_limiting.py", line 192, in deduct_user_credits
      deduct_credits(user.id, credits, usage_log_id, db, description)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/app/credit_manager.py", line 134, in deduct_credits
      db.commit()
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
      trans.commit(_to_root=True)
    File "<string>", line 2, in commit
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
      ret_value = fn(self, *arg, **kw)
                  ^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1311, in commit
      self._prepare_impl()
    File "<string>", line 2, in _prepare_impl
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
      ret_value = fn(self, *arg, **kw)
                  ^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1286, in _prepare_impl
      self.session.flush()
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4331, in flush
      self._flush(objects)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4466, in _flush
      with util.safe_reraise():
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 228, in __exit__
      raise value.with_traceback(traceback)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4467, in _flush
      transaction.rollback(_capture_exception=True)
    File "<string>", line 2, in rollback
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 101, in _go
      self._raise_for_prerequisite_state(fn.__name__, current_state)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 986, in _raise_for_prerequisite_state
      raise sa_exc.ResourceClosedError("This transaction is closed")
  sqlalchemy.exc.ResourceClosedError: This transaction is closed
  
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.
    warnings.warn(pytest.PytestUnhandledThreadExceptionWarning(msg))

tests/unit/test_rate_limiting_edge_cases.py::TestConcurrentAccess::test_concurrent_deduction
  /home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py:58: PytestUnhandledThreadExceptionWarning: Exception in thread Thread-115 (deduct)
  
  Traceback (most recent call last):
    File "/usr/lib/python3.12/threading.py", line 1073, in _bootstrap_inner
      self.run()
    File "/usr/lib/python3.12/threading.py", line 1010, in run
      self._target(*self._args, **self._kwargs)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_rate_limiting_edge_cases.py", line 286, in deduct
      deduct_user_credits(test_user_free, Decimal("1"), None, db_session, "Concurrent test")
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/app/rate_limiting.py", line 192, in deduct_user_credits
      deduct_credits(user.id, credits, usage_log_id, db, description)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/app/credit_manager.py", line 134, in deduct_credits
      db.commit()
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
      trans.commit(_to_root=True)
    File "<string>", line 2, in commit
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
      ret_value = fn(self, *arg, **kw)
                  ^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1329, in commit
      self._parent.commit(_to_root=True)
    File "<string>", line 2, in commit
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 119, in _go
      raise sa_exc.IllegalStateChangeError(
  sqlalchemy.exc.IllegalStateChangeError: Method 'commit()' can't be called here; method '_prepare_impl()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
  
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.
    warnings.warn(pytest.PytestUnhandledThreadExceptionWarning(msg))

tests/unit/test_rate_limiting_edge_cases.py::TestConcurrentAccess::test_concurrent_deduction
  /home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/_pytest/threadexception.py:58: PytestUnhandledThreadExceptionWarning: Exception in thread Thread-114 (deduct)
  
  Traceback (most recent call last):
    File "/usr/lib/python3.12/threading.py", line 1073, in _bootstrap_inner
      self.run()
    File "/usr/lib/python3.12/threading.py", line 1010, in run
      self._target(*self._args, **self._kwargs)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/tests/unit/test_rate_limiting_edge_cases.py", line 286, in deduct
      deduct_user_credits(test_user_free, Decimal("1"), None, db_session, "Concurrent test")
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/app/rate_limiting.py", line 192, in deduct_user_credits
      deduct_credits(user.id, credits, usage_log_id, db, description)
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/app/credit_manager.py", line 134, in deduct_credits
      db.commit()
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 2030, in commit
      trans.commit(_to_root=True)
    File "<string>", line 2, in commit
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
      ret_value = fn(self, *arg, **kw)
                  ^^^^^^^^^^^^^^^^^^^^
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 1329, in commit
      self._parent.commit(_to_root=True)
    File "<string>", line 2, in commit
    File "/home/dan_wsl/jaydeelew/CompareIntel/backend/venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py", line 119, in _go
      raise sa_exc.IllegalStateChangeError(
  sqlalchemy.exc.IllegalStateChangeError: Method 'commit()' can't be called here; method '_prepare_impl()' is already in progress and this would cause an unexpected state change to <SessionTransactionState.CLOSED: 5> (Background on this error at: https://sqlalche.me/e/20/isce)
  
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.
    warnings.warn(pytest.PytestUnhandledThreadExceptionWarning(msg))

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.3-final-0 ________________

Name                                     Stmts   Miss  Cover   Missing
----------------------------------------------------------------------
app/auth.py                                 71     10    86%   45-47, 66-67, 122, 129, 135-141
app/cache.py                                88     63    28%   33-43, 47-48, 52-53, 57, 61-68, 88-111, 130-140, 145-146, 159-166, 175-176, 192-202, 207-209
app/config/__init__.py                      14      5    64%   71-78
app/config/constants.py                     12      0   100%
app/config/helpers.py                       12      2    83%   27, 69
app/config/settings.py                      42      2    95%   21, 62
app/config/validation.py                   108     48    56%   46, 51, 57, 66, 68, 86-95, 102, 112, 123, 128, 130, 136, 138, 145, 147, 157, 166, 168, 177-178, 181-182, 199, 224-233, 245-250
app/credit_manager.py                      156     49    69%   44, 104, 151, 176-186, 200-204, 255-263, 281, 285, 290, 329-355, 426-427, 440-449
app/data_retention.py                      104    104     0%   9-253
app/database.py                             63     33    48%   34, 48, 71, 108-142, 150-152, 161-163
app/dependencies.py                         86     43    50%   43-78, 133, 137-138, 168-181, 197-208, 220
app/email_service.py                       126    126     0%   8-743
app/main.py                                135     57    58%   94, 107-115, 131, 174-206, 227-241, 264, 269-292, 297-302
app/middleware/__init__.py                   0      0   100%
app/middleware/profiling.py                 25      3    88%   54, 58, 62
app/mock_responses.py                        9      0   100%
app/model_runner.py                       1459   1283    12%   130-142, 160-179, 797-828, 882-919, 956-958, 989-996, 1012-1039, 1068-1071, 1086, 1090-1093, 1109-1112, 1121, 1135-1139, 1153-1157, 1180-1212, 1223-1239, 1253-1276, 1295-1326, 1368, 1385, 1410-1456, 1484-1486, 1500-1504, 1533-1550, 1562-1576, 1642, 1646-1652, 1656-1660, 1671-1684, 1693-1694, 1702, 1707, 1731-1736, 1746-1756, 1763, 1770-3611, 3625-3626, 3633-3636, 3640-3659, 3662-3666, 3684-3692, 3698-3709, 3712-3723, 3755-3792, 3797-3833
app/models.py                              188      1    99%   85
app/rate_limiting.py                       192     68    65%   111-116, 135-137, 227-271, 273, 279-290, 315-316, 344, 350-359, 453, 469, 510-513, 523, 539-540, 553-554, 567-568, 581, 591
app/routers/__init__.py                      0      0   100%
app/routers/admin.py                      1311   1200     8%   52, 70-96, 106-141, 160-256, 285-318, 335-346, 359-397, 411-478, 490-567, 580-602, 614-644, 658-696, 708-735, 758-805, 823-863, 876-931, 944-988, 1015-1067, 1091-1163, 1208-1227, 1272-1298, 1309-1322, 1332-1343, 1351-1371, 1402-1424, 1438-1456, 1469-1503, 1523-1556, 1566, 1582-1663, 1675-1680, 1697-1715, 1729-1743, 1757-2072, 2090-2673, 2687-2914, 2933-2958, 2976-3016, 3032-3060, 3078-3117
app/routers/api.py                        1027    937     9%   165-179, 190-221, 241-272, 277-284, 301-351, 362-386, 405-448, 454-466, 483-512, 538-550, 585-1967, 1976-2047, 2057-2122, 2158-2298, 2319-2358, 2374-2394, 2411-2502
app/routers/auth.py                        278     90    68%   60, 80-84, 113-114, 121-160, 178-252, 333-339, 362, 366, 371-372, 389-392, 449-453, 472-474, 509-511, 542
app/routers/dev.py                          92     92     0%   8-266
app/schemas.py                             271     29    89%   33, 35, 37, 41, 144, 146, 148, 152, 212-214, 236-238, 290-292, 383-394
app/search/__init__.py                       5      0   100%
app/search/base.py                          19      3    84%   41, 51, 61
app/search/brave.py                         46      8    83%   34-36, 53, 112, 116-118
app/search/distributed_rate_limiter.py     410    318    22%   32-35, 91-95, 107-122, 126-138, 146-151, 155-164, 168-181, 185-201, 248-253, 259, 268-329, 333-347, 392-393, 417, 432-435, 439-492, 496, 500-535, 542-557, 570-688, 698-808, 815-819, 823-828, 833-856
app/search/factory.py                       45      9    80%   44-48, 57-62, 95
app/search/rate_limiter.py                 167    112    33%   53-54, 63-79, 83-93, 97-103, 107-108, 135-154, 158, 162-169, 184-237, 241-243, 252-273, 278-295, 344-360, 380-396, 402-405
app/search/retry.py                         68     39    43%   70-104, 107-116, 124-126, 140-165
app/types.py                                94      0   100%
app/utils/cookies.py                        21      0   100%
----------------------------------------------------------------------
TOTAL                                     6744   4734    30%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml
=========================== short test summary info ============================
FAILED tests/unit/test_auth.py::TestUserRegistration::test_register_new_user - assert 400 == 201
 +  where 400 = <Response [400 Bad Request]>.status_code
 +  and   201 = status.HTTP_201_CREATED
FAILED tests/unit/test_auth.py::TestTokenRefresh::test_refresh_token_unauthorized - assert 401 == 422
 +  where 401 = <Response [401 Unauthorized]>.status_code
 +  and   422 = status.HTTP_422_UNPROCESSABLE_ENTITY
FAILED tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_access_token_as_refresh_token - assert 200 == 401
 +  where 200 = <Response [200 OK]>.status_code
 +  and   401 = status.HTTP_401_UNAUTHORIZED
FAILED tests/unit/test_auth_edge_cases.py::TestTokenEdgeCases::test_refresh_token_as_access_token - assert 200 == 401
 +  where 200 = <Response [200 OK]>.status_code
 +  and   401 = status.HTTP_401_UNAUTHORIZED
FAILED tests/unit/test_rate_limiting.py::TestUserCreditLimiting::test_credits_exceeded - AssertionError: assert 100 < Decimal('5')
FAILED tests/unit/test_rate_limiting.py::TestAllTierCredits::test_free_tier_exceeds_credits - assert True is False
FAILED tests/unit/test_rate_limiting.py::TestAllTierCredits::test_starter_tier_exceeds_credits - assert True is False
FAILED tests/unit/test_rate_limiting.py::TestAllTierCredits::test_pro_tier_exceeds_credits - assert True is False
FAILED tests/unit/test_rate_limiting_edge_cases.py::TestUserCreditBoundaries::test_credits_at_exact_limit - assert True is False
FAILED tests/unit/test_rate_limiting_edge_cases.py::TestUserCreditBoundaries::test_credits_one_below_limit - assert 100 == 1
FAILED tests/unit/test_rate_limiting_edge_cases.py::TestUserCreditBoundaries::test_credits_one_above_limit - assert True is False
FAILED tests/unit/test_rate_limiting_edge_cases.py::TestCreditReset::test_no_reset_same_day - assert 100 < 100
FAILED tests/unit/test_rate_limiting_edge_cases.py::TestDeductCredits::test_deduct_by_multiple - assert 0 >= (0 + 10)
 +  where 0 = <app.models.User object at 0x755e9a807290>.credits_used_this_period
FAILED tests/unit/test_rate_limiting_edge_cases.py::TestAnonymousCreditBoundaries::test_anonymous_one_below_limit - assert False is True
FAILED tests/unit/test_rate_limiting_edge_cases.py::TestUsageStats::test_usage_stats_at_limit - ImportError: cannot import name 'get_db' from 'app.models' (/home/dan_wsl/jaydeelew/CompareIntel/backend/app/models.py)
FAILED tests/unit/test_utils.py::TestConstants::test_extended_tier_limits_exist - ImportError: cannot import name 'EXTENDED_TIER_LIMITS' from 'app.config' (/home/dan_wsl/jaydeelew/CompareIntel/backend/app/config/__init__.py)
============ 16 failed, 131 passed, 99 warnings in 63.15s (0:01:03) ============
